# üìò Base de Conhecimento T√©cnica ‚Äì Projeto **Entregatudo**

*Documento consolidado a partir de 9 fontes.  
Ordenado por camadas de profundidade e, dentro de cada camada, em ordem alfab√©tica.  
Formato: BackEnd ‚Üí FrontEnd.  
Numera√ß√£o hier√°rquica aplicada.*

---

## 1. N√çVEL SUPERFICIAL ‚Äì Vis√£o Geral

### 1.1 BackEnd ‚Äì Vis√£o Geral  
1.1.1. **Autentica√ß√£o**: JWT ap√≥s valida√ß√£o (login cl√°ssico ou Google OAuth2).  
1.1.2. **Endpoints p√∫blicos** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `/api/cadboy`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `/api/heartbeat`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `/api/login`  
&nbsp;&nbsp;&nbsp;&nbsp;d. `/api/login/google/callback`  
&nbsp;&nbsp;&nbsp;&nbsp;e. `/api/login/status`  
&nbsp;&nbsp;&nbsp;&nbsp;f. `/api/next-user-id`  
&nbsp;&nbsp;&nbsp;&nbsp;g. `/api/obtemCfgValores`  
1.1.3. **Modelos JSON**: `Config`, `FornecedorHeartbeatResponse`, `NovaVenda`  
1.1.4. **Tecnologia**: PHP/Laravel ‚Äì APIs RESTful  

### 1.2 FrontEnd ‚Äì Vis√£o Geral  
1.2.1. **Gerenciamento de estado**: Provider (escopo simples) ou Bloc (escopo complexo)  
1.2.2. **Integra√ß√£o**: pacote `http` ‚Äì todas as chamadas REST  
1.2.3. **Pastas principais** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `lib/models`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `lib/screens`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `lib/services`  
&nbsp;&nbsp;&nbsp;&nbsp;d. `lib/widgets`  
1.2.4. **Tecnologia**: Flutter 3.x ‚Äì estrutura modular  
1.2.5. **Widgets reutiliz√°veis** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `ConfigForm`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `DeliveryCard`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `LoginForm`  

---

## 2. N√çVEL INTERMEDI√ÅRIO ‚Äì Estruturas e Fluxos

### 2.1 BackEnd ‚Äì Estruturas  
2.1.1. **Endpoints detalhados** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `/api/cadboy` ‚Äì POST ‚Äì body `{nome, cpf, placa, senha}` ‚Üí `{success, motoboy_id}`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `/api/heartbeat` ‚Äì POST ‚Äì header `Authorization: Bearer <JWT>` ‚Äì body `{lat, lng}` ‚Üí `FornecedorHeartbeatResponse`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `/api/login` ‚Äì POST ‚Äì body `{email, senha}` ‚Üí `{token, refresh_token, user}`  
&nbsp;&nbsp;&nbsp;&nbsp;d. `/api/login/google/callback?ID=<id>` ‚Äì POST ‚Äì body `{idToken}` ‚Üí `{success, message}`  
&nbsp;&nbsp;&nbsp;&nbsp;e. `/api/login/status?ID=<id>` ‚Äì GET ‚Üí `{done, success, user_id, is_new_user, message?}`  
&nbsp;&nbsp;&nbsp;&nbsp;f. `/api/next-user-id` ‚Äì GET ‚Üí `{success, nextId}`  
&nbsp;&nbsp;&nbsp;&nbsp;g. `/api/obtemCfgValores` ‚Äì GET ‚Üí `{taxa, distanciaMax, modos}`  

2.1.2. **Modelos PHP** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `Config {taxa, distanciaMax, modos}`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `FornecedorHeartbeatResponse {modo, lojasNoRaio[], idLoja, novaVenda?}`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `NovaVenda {hora, valor, cliente, idPed, idAviso}`  

2.1.3. **Processos internos** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `cadboy()` ‚Äì valida JWT ‚Üí insert motoboy ‚Üí retorna id  
&nbsp;&nbsp;&nbsp;&nbsp;b. `googleLoginCallback()` ‚Äì valida idToken Google ‚Üí insert/update users ‚Üí marca fila como ‚Äúprocessing‚Äù  
&nbsp;&nbsp;&nbsp;&nbsp;c. `googleLoginStatus()` ‚Äì polling na fila ‚Üí retorna estado final  
&nbsp;&nbsp;&nbsp;&nbsp;d. `nextUserId()` ‚Äì consulta `information_schema` para `AUTO_INCREMENT`  
&nbsp;&nbsp;&nbsp;&nbsp;e. `obtemCfgValores()` ‚Äì SELECT na tabela `config`  
&nbsp;&nbsp;&nbsp;&nbsp;f. `saveConfigurations()` ‚Äì UPDATE na tabela `config`  
&nbsp;&nbsp;&nbsp;&nbsp;g. `sendHeartbeat()` ‚Äì grava posi√ß√£o ‚Üí SELECT lojas dentro do raio ‚Üí monta `FornecedorHeartbeatResponse`  

### 2.2 FrontEnd ‚Äì Estruturas  
2.2.1. **Integra√ß√µes REST** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `fetchConfigurations()` ‚Äì GET `/api/obtemCfgValores`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `loginUser()` ‚Äì POST `/api/login`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `sendHeartbeat()` ‚Äì POST `/api/heartbeat`  

2.2.2. **Widgets** (ordem alfab√©tica):  
&nbsp;&nbsp;&nbsp;&nbsp;a. `ConfigForm` ‚Äì FormField duplo: taxa (double) + dist√¢ncia (int) ‚Äì bot√£o ‚ÄúSalvar‚Äù chama `saveConfigurations()`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `DeliveryCard` ‚Äì Card com leading foto da loja, title nome da loja, subtitle dist√¢ncia/tempo estimado  
&nbsp;&nbsp;&nbsp;&nbsp;c. `LoginForm` ‚Äì campos email/senha ‚Äì valida√ß√£o m√≠n 3 chars ‚Äì bot√£o ‚ÄúEntrar‚Äù chama `loginUser()`  

---

## 3. N√çVEL PROFUNDO ‚Äì C√≥digo e M√©todos Internos

### 3.1 BackEnd ‚Äì C√≥digo PHP (ordem alfab√©tica de m√©todos)  
3.1.1. `cadboy(Request $req)`  
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $data = $req->validate([...]);
    $id = DB::table('motoboy')->insertGetId($data);
    return response()->json(['success' => true, 'motoboy_id' => $id]);
    ```  

3.1.2. `googleLoginCallback(Request $req)`  
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $idToken = $req->input('idToken');
    $googleId = $this->verifyGoogleToken($idToken);
    $user = User::firstOrCreate(['google_id' => $googleId], [...]);
    LoginQueue::updateOrCreate(['id' => $req->ID], ['done' => false, 'user_id' => $user->id]);
    return response()->json(['success' => true, 'message' => 'processing']);
    ```  

3.1.3. `googleLoginStatus(Request $req)`  
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $q = LoginQueue::find($req->ID);
    if (!$q || !$q->done) return response()->json(['done' => false]);
    return response()->json([
        'done' => true,
        'success' => true,
        'user_id' => $q->user_id,
        'is_new_user' => $q->is_new_user
    ]);
    ```  

3.1.4. `nextUserId()`  
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $next = DB::select("SELECT AUTO_INCREMENT as nextId FROM information_schema.tables WHERE table_name = 'users'")[0]->nextId;
    return response()->json(['success' => true, 'nextId' => $next]);
    ```  

3.1.5. `obtemCfgValores()`  
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $cfg = Config::first();
    return response()->json($cfg);
    ```  

### 3.2 FrontEnd ‚Äì C√≥digo Dart  

#### 3.2.1. **api.dart**  
3.2.1.1. `nextUserId()`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final url = Uri.parse('https://teletudo.com/api/next-user-id');
    final res = await http.get(url, headers: {'Accept':'application/json'});
    if (res.statusCode == 200) {
      final d = json.decode(res.body);
      if (d['success'] == true) return d['nextId'] is int ? d['nextId'] : int.tryParse('${d['nextId']}');
    }
    return null;
    ```  

3.2.1.2. `googleLoginInit({required String idToken, required int userIdForQuery})`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final url = Uri.parse('https://teletudo.com/api/login/google/callback?ID=$userIdForQuery');
    final res = await http.post(url, body: {'idToken': idToken}, headers: {'Accept':'application/json'});
    return json.decode(res.body);
    ```  

3.2.1.3. `googleLoginStatus({required int userIdForQuery})`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final url = Uri.parse('https://teletudo.com/api/login/status?ID=$userIdForQuery');
    final res = await http.get(url, headers: {'Accept':'application/json'});
    return json.decode(res.body);
    ```  

#### 3.2.2. **auth_service.dart**  
3.2.2.1. `signInWithGoogle()`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final int? maybeId = await API.nextUserId();
    if (maybeId == null) return AuthResult.error('Falha ao obter ID');
    final GoogleSignInAccount? account = await _googleSignIn.signIn();
    if (account == null) return AuthResult.cancelled();
    final GoogleSignInAuthentication auth = await account.authentication;
    await API.googleLoginInit(idToken: auth.idToken!, userIdForQuery: maybeId);
    return await _trazCredenciais(maybeId);
    ```  

3.2.2.2. `_trazCredenciais(int id)`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    for (int i = 0; i < 40; i++) {
      final res = await API.googleLoginStatus(userIdForQuery: id);
      if (res['done'] == true) {
        if (res['success'] == true) {
          final user = User.fromJson(res);
          await _salvaLocal(user, res['accessToken'], res['refreshToken']);
          return AuthResult.success(user, res['is_new_user']);
        } else {
          return AuthResult.error(res['message'] ?? 'Erro desconhecido');
        }
      }
      await Future.delayed(Duration(milliseconds: 500));
    }
    return AuthResult.timeout();
    ```  

#### 3.2.3. **Models**  
3.2.3.1. `AuthResult`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    class AuthResult {
      final bool success;
      final User? user;
      final bool? isNewUser;
      final String? error;
      // construtores: success, error, cancelled, timeout
    }
    ```  

3.2.3.2. `Config`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    Config.fromJson(Map<String,dynamic> j)
        : taxa = j['taxa'].toDouble(),
          distanciaMax = j['distanciaMax'],
          modos = List<String>.from(j['modos']);
    ```  

3.2.3.3. `User`  
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    User.fromJson(Map<String,dynamic> j)
        : id = j['user_id'],
          nome = j['nome'] ?? '',
          email = j['email'] ?? '',
          fotoUrl = j['fotoUrl'] ?? '',
          googleId = j['google_id'];
    ```  

#### 3.2.4. **Persist√™ncia local ‚Äì chaves**  
3.2.4.1. **SecureStorageKeys**: `accessToken`, `refreshToken`  
3.2.4.2. **SharedPrefsKeys**: `email`, `fotoUrl`, `idUser`, `isLogado`, `nome`  

#### 3.2.5. **Tratamento de erros**  
3.2.5.1. `Erro de rede`: catch em `http.get`/`post` ‚Üí ‚ÄúVerifique sua conex√£o‚Äù  
3.2.5.2. `Timeout 20 s`: loop finaliza ‚Üí `AuthResult.timeout()` ‚Üí UI exibe ‚ÄúTente novamente‚Äù  
3.2.5.3. `Token inv√°lido`: backend retorna `success=false` ‚Üí limpa sess√£o ‚Üí redireciona para login  

---

## 4. N√çVEL DE INFRAESTRUTURA E BUILD (Opcional ‚Äì Profundidade Extra)

### 4.1 Scripts de Build (Windows)  
4.1.1. `compila.bat`:  
&nbsp;&nbsp;&nbsp;&nbsp;a. `flutter clean`  
&nbsp;&nbsp;&nbsp;&nbsp;b. `flutter pub get`  
&nbsp;&nbsp;&nbsp;&nbsp;c. `gradlew clean`  
&nbsp;&nbsp;&nbsp;&nbsp;d. `flutter build apk --release --no-tree-shake-icons`  
&nbsp;&nbsp;&nbsp;&nbsp;e. renomeia para `EntregaTudo.apk`  
&nbsp;&nbsp;&nbsp;&nbsp;f. executa `upa.bat`  

4.1.2. `upa.bat`:  
&nbsp;&nbsp;&nbsp;&nbsp;a. Copia APK para `...\public\download`  
&nbsp;&nbsp;&nbsp;&nbsp;b. Executa cliente FTP (`FTPc.exe`)  

### 4.2 Permiss√µes Android (`AndroidManifest.xml`)  
4.2.1. `INTERNET`  
4.2.2. `ACCESS_FINE_LOCATION`  
4.2.3. `ACCESS_COARSE_LOCATION`  
4.2.4. `ACCESS_BACKGROUND_LOCATION`  

---

## 5. √çNDICE REMISSIVO ALFAB√âTICO (Termos-Chave)

- **accessToken**  
- **API.fetchConfigurations**  
- **API.googleLoginInit**  
- **API.googleLoginStatus**  
- **API.loginUser**  
- **API.nextUserId**  
- **API.sendHeartbeat**  
- **AuthResult**  
- **AuthService**  
- **cadboy()**  
- **Config**  
- **ConfigForm**  
- **DeliveryCard**  
- **distanciaMax**  
- **FornecedorHeartbeatResponse**  
- **googleLoginCallback()**  
- **googleLoginStatus()**  
- **heartbeat**  
- **idUser**  
- **JWT**  
- **lib/models**  
- **LoginForm**  
- **modos**  
- **NovaVenda**  
- **obtemCfgValores()**  
- **polling**  
- **Provider / Bloc**  
- **refreshToken**  
- **saveConfigurations()**  
- **SharedPrefsKeys**  
- **taxa**  
- **timeout (20 s)**  
- **User**  
