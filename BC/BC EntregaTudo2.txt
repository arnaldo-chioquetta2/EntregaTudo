Aqui estÃ¡ a Base de Conhecimento consolidada, integrando a documentaÃ§Ã£o de expansÃ£o (Projeto EntregaTudo - ExpansÃ£o da Base TÃ©cnica) com a base original (BC EntregaTudo.txt).

O conteÃºdo foi fundido seguindo a estrutura hierÃ¡rquica e a ordem alfabÃ©tica estabelecidas no documento original.

-----

# ğŸ“˜ Base de Conhecimento TÃ©cnica Consolidada â€“ Projeto **Entregatudo**

*Documento consolidado a partir de 9 fontes e da documentaÃ§Ã£o "ExpansÃ£o da Base TÃ©cnica".
Ordenado por camadas de profundidade e, dentro de cada camada, em ordem alfabÃ©tica.
NumeraÃ§Ã£o hierÃ¡rquica aplicada.*

-----

## 1\. NÃVEL SUPERFICIAL â€“ VisÃ£o Geral

### 1.1 BackEnd â€“ VisÃ£o Geral

1.1.1.
**AutenticaÃ§Ã£o**: JWT apÃ³s validaÃ§Ã£o (login clÃ¡ssico ou Google OAuth2).
1.1.2. **Endpoints principais** (ordem alfabÃ©tica):
Â Â Â Â a. `/api/cadboy`
Â Â Â Â b.
`/api/heartbeat`
Â Â Â Â c. `/api/login`
Â Â Â Â d. `/api/login/google/callback`
Â Â Â Â e. `/api/login/status`
Â Â Â Â f. `/api/next-user-id`
Â Â Â Â g. `/api/notifyDeliveryCompleted`
Â Â Â Â h. `/api/obtemCfgValores`
1.1.3.
**Modelos JSON**: `Config`, `FornecedorHeartbeatResponse`, `NovaVenda`
1.1.4. **Tecnologia**: PHP/Laravel â€“ APIs RESTful
1.1.5. **Fluxo de ConfirmaÃ§Ã£o (Novo)**:
Â Â Â Â a. O `codigoConfirmacao` (4 dÃ­gitos) Ã© gerado pelo servidor.
Â Â Â Â b. Este cÃ³digo Ã© enviado ao motoboy junto com os dados da `NovaVenda`.
Â Â Â Â c. O endpoint `/api/notifyDeliveryCompleted` Ã© usado para finalizar a entrega apÃ³s a validaÃ§Ã£o deste cÃ³digo.

### 1.2 FrontEnd â€“ VisÃ£o Geral

1.2.1.
**Gerenciamento de estado**: Provider (escopo simples) ou Bloc (escopo complexo)
1.2.2.
**IntegraÃ§Ã£o**: pacote `http` â€“ todas as chamadas REST
1.2.3. **Pastas principais** (ordem alfabÃ©tica):
Â Â Â Â a. `lib/models`
Â Â Â Â b.
`lib/screens`
Â Â Â Â c. `lib/services`
Â Â Â Â d. `lib/widgets`
1.2.4. **Tecnologia**: Flutter 3.x â€“ estrutura modular . Inclui suporte para Flutter Desktop.
1.2.5.
**Widgets reutilizÃ¡veis** (ordem alfabÃ©tica):
Â Â Â Â a. `ConfigForm`
Â Â Â Â b. `DeliveryCard`
Â Â Â Â c.
`LoginForm`
Â Â Â Â d. Telas de ConfirmaÃ§Ã£o de CÃ³digo
1.2.6. **Fluxo de ConfirmaÃ§Ã£o (Novo)**:
Â Â Â Â a. O app utiliza telas de confirmaÃ§Ã£o de cÃ³digo no Flutter Desktop para finalizar entregas.
Â Â Â Â b. O fluxo valida o cÃ³digo localmente (via SharedPreferences) antes de notificar o backend.
Â Â Â Â c. A chamada `API.notifyDeliveryCompleted` sÃ³ Ã© feita apÃ³s a aprovaÃ§Ã£o local.
1.2.7. **PersistÃªncia Adicional (Novo)**:
Â Â Â Â a. O app salva dados adicionais da entrega no dispositivo.
Â Â Â Â b. Chaves incluem: `codigoConfirmacao` e `currentChamado`.

-----

## 2\. NÃVEL INTERMEDIÃRIO â€“ Estruturas e Fluxos

### 2.1 BackEnd â€“ Estruturas

2.1.1.
**Endpoints detalhados** (ordem alfabÃ©tica):
Â Â Â Â a. `/api/cadboy` â€“ POST â€“ body `{nome, cpf, placa, senha}` â†’ `{success, motoboy_id}`
Â Â Â Â b.
`/api/heartbeat` â€“ POST â€“ header `Authorization: Bearer <JWT>` â€“ body `{lat, lng}` â†’ `FornecedorHeartbeatResponse`
Â Â Â Â c.
`/api/login` â€“ POST â€“ body `{email, senha}` â†’ `{token, refresh_token, user}`
Â Â Â Â d.
`/api/login/google/callback?ID=<id>` â€“ POST â€“ body `{idToken}` â†’ `{success, message}`
Â Â Â Â e.
`/api/login/status?ID=<id>` â€“ GET â†’ `{done, success, user_id, is_new_user, message?}`
Â Â Â Â f. `/api/next-user-id` â€“ GET â†’ `{success, nextId}`
Â Â Â Â g. `/api/notifyDeliveryCompleted` â€“ POST â€“ body `{chamado}` â†’ HTTP 200
Â Â Â Â h.
`/api/obtemCfgValores` â€“ GET â†’ `{taxa, distanciaMax, modos}`

2.1.2. **Modelos PHP** (ordem alfabÃ©tica):
Â Â Â Â a.
`Config {taxa, distanciaMax, modos}`
Â Â Â Â b. `FornecedorHeartbeatResponse {modo, lojasNoRaio[], idLoja, novaVenda?}`
Â Â Â Â c.
`NovaVenda {hora, valor, cliente, idPed, idAviso, codigoConfirmacao?}`

2.1.3. **Processos internos** (ordem alfabÃ©tica):
Â Â Â Â a.
`cadboy()` â€“ valida JWT â†’ insert motoboy â†’ retorna id
Â Â Â Â b.
`googleLoginCallback()` â€“ valida idToken Google â†’ insert/update users â†’ marca fila como â€œprocessingâ€
Â Â Â Â c.
`googleLoginStatus()` â€“ polling na fila â†’ retorna estado final
Â Â Â Â d. `nextUserId()` â€“ consulta `information_schema` para `AUTO_INCREMENT`
Â Â Â Â e. `notifyDeliveryCompleted()` â€“ Recebe `{ "chamado": X }` e atualiza o status da entrega para "concluÃ­da".
Â Â Â Â f.
`obtemCfgValores()` â€“ SELECT na tabela `config`
Â Â Â Â g. `saveConfigurations()` â€“ UPDATE na tabela `config`
Â Â Â Â h.
`sendHeartbeat()` â€“ grava posiÃ§Ã£o â†’ SELECT lojas dentro do raio â†’ monta `FornecedorHeartbeatResponse` (incluindo `codigoConfirmacao` se houver nova venda).

### 2.2 FrontEnd â€“ Estruturas

2.2.1.
**IntegraÃ§Ãµes REST** (ordem alfabÃ©tica):
Â Â Â Â a. `fetchConfigurations()` â€“ GET `/api/obtemCfgValores`
Â Â Â Â b. `loginUser()` â€“ POST `/api/login`
Â Â Â Â c. `notifyDeliveryCompleted()` â€“ POST `/api/notifyDeliveryCompleted`
Â Â Â Â d.
`sendHeartbeat()` â€“ POST `/api/heartbeat`

2.2.2. **Widgets** (ordem alfabÃ©tica):
Â Â Â Â a.
`ConfigForm` â€“ FormField duplo: taxa (double) + distÃ¢ncia (int) â€“ botÃ£o â€œSalvarâ€ chama `saveConfigurations()`
Â Â Â Â b.
`DeliveryCard` â€“ Card com leading foto da loja, title nome da loja, subtitle distÃ¢ncia/tempo estimado
Â Â Â Â c.
`LoginForm` â€“ campos email/senha â€“ validaÃ§Ã£o mÃ­n 3 chars â€“ botÃ£o â€œEntrarâ€ chama `loginUser()`
Â Â Â Â d. `TelaConfirmacaoCodigo` â€“ TextField numÃ©rico (4 dÃ­gitos), botÃµes OK, Cancelar e Relatar Problema.

2.2.3. **Fluxos e MÃ©todos de UI (Novos)**:
Â Â Â Â a. `handleDeliveryCompleted()`: MÃ©todo refatorado que agora chama a `mostrarTelaCodigoConfirmacao()` e, se o retorno for `true`, chama `API.notifyDeliveryCompleted()`.
Â Â Â Â b. `mostrarAvisoNovaVenda()`: MÃ©todo refatorado (extraÃ­do do `heartbeat`) que exibe o diÃ¡logo de nova venda (com dados do cliente, itens e timer regressivo).
Â Â Â Â c. `mostrarTelaCodigoConfirmacao()`: Controla a tela de inserÃ§Ã£o do PIN, lÃª o cÃ³digo correto de SharedPreferences, valida a entrada do motoboy e retorna `true` ou `false`.

-----

## 3\. NÃVEL PROFUNDO â€“ CÃ³digo e MÃ©todos Internos

### 3.1 BackEnd â€“ CÃ³digo PHP (ordem alfabÃ©tica de mÃ©todos)

3.1.1.
`cadboy(Request $req)`
Â Â Â Â \`\`\`php
$data = $req-\>validate([...]);
$id = DB::table('motoboy')->insertGetId($data);
return response()-\>json(['success' =\> true, 'motoboy\_id' =\> $id]);

````

3.1.2. `googleLoginCallback(Request $req)`
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $idToken = $req->input('idToken');
    $googleId = $this->verifyGoogleToken($idToken);
$user = User::firstOrCreate(['google_id' => $googleId], [...]);
    LoginQueue::updateOrCreate(['id' => $req->ID], ['done' => false, 'user_id' => $user->id]);
return response()->json(['success' => true, 'message' => 'processing']);
    ```

3.1.3. `googleLoginStatus(Request $req)`
&nbsp;&nbsp;&nbsp;&nbsp;```php
    $q = LoginQueue::find($req->ID);
if (!$q || !$q->done) return response()->json(['done' => false]);
    return response()->json([
        'done' => true,
        'success' => true,
        'user_id' => $q->user_id,
        'is_new_user' => $q->is_new_user
    ]);
````

3.1.4. `nextUserId()`
Â Â Â Â ` php $next = DB::select("SELECT AUTO_INCREMENT as nextId FROM information_schema.tables WHERE table_name = 'users'")[0]->nextId; return response()->json(['success' => true, 'nextId' => $next]);  `

3.1.5. `notifyDeliveryCompleted(Request $req)`
Â Â Â Â ` php // Recebe JSON: { "chamado": X } // LÃ³gica: $chamadoId = $req->input('chamado'); // DB::table('chamados')->where('id', $chamadoId)->update(['status' => 'concluida']); return response()->json(['success' => true], 200);  `

3.1.6. `obtemCfgValores()`
Â Â Â Â ` php $cfg = Config::first(); return response()->json($cfg);  `

### 3.2 FrontEnd â€“ CÃ³digo Dart

#### 3.2.1. **api.dart**

3.2.1.1.
`nextUserId()`
Â Â Â Â \`\`\`dart
final url = Uri.parse('https://teletudo.com/api/next-user-id');
final res = await http.get(url, headers: {'Accept':'application/json'});
if (res.statusCode == 200) {
final d = json.decode(res.body);
if (d['success'] == true) return d['nextId'] is int ? d['nextId'] : int.tryParse('${d['nextId']}');
}
return null;

````

3.2.1.2. `googleLoginInit({required String idToken, required int userIdForQuery})`
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final url = Uri.parse('https://teletudo.com/api/login/google/callback?ID=$userIdForQuery');
final res = await http.post(url, body: {'idToken': idToken}, headers: {'Accept':'application/json'});
    return json.decode(res.body);
    ```

3.2.1.3.
`googleLoginStatus({required int userIdForQuery})`
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final url = Uri.parse('https://teletudo.com/api/login/status?ID=$userIdForQuery');
    final res = await http.get(url, headers: {'Accept':'application/json'});
return json.decode(res.body);
    ```
3.2.1.4. `notifyDeliveryCompleted()`
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    static Future<bool> notifyDeliveryCompleted() async {
      try {
        const String baseUrl = "https://teletudo.com/api/notifyDeliveryCompleted";

        final SharedPreferences prefs = await SharedPreferences.getInstance();
        int? currentChamado = prefs.getInt('currentChamado');

        final response = await http.post(
          Uri.parse(baseUrl),
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: json.encode({'chamado': currentChamado}),
        );

        return response.statusCode == 200;
      } catch (e) {
        return false;
      }
    }
    ```

#### 3.2.2. **auth_service.dart**
3.2.2.1. `signInWithGoogle()`
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    final int?
maybeId = await API.nextUserId();
    if (maybeId == null) return AuthResult.error('Falha ao obter ID');
    final GoogleSignInAccount? account = await _googleSignIn.signIn();
if (account == null) return AuthResult.cancelled();
    final GoogleSignInAuthentication auth = await account.authentication;
    await API.googleLoginInit(idToken: auth.idToken!, userIdForQuery: maybeId);
    return await _trazCredenciais(maybeId);
````

3.2.2.2. `_trazCredenciais(int id)`
Â Â Â Â ` dart for (int i = 0; i < 40; i++) { final res = await API.googleLoginStatus(userIdForQuery: id); if (res['done'] == true) { if (res['success'] == true) { final user = User.fromJson(res); await _salvaLocal(user, res['accessToken'], res['refreshToken']); return AuthResult.success(user, res['is_new_user']); } else { return AuthResult.error(res['message'] ?? 'Erro desconhecido'); } } await Future.delayed(Duration(milliseconds: 500)); } return AuthResult.timeout();  `

#### 3.2.3. **LÃ³gica de Fluxo (ImplementaÃ§Ãµes)**

3.2.3.1. `handleDeliveryCompleted()`:
Â Â Â Â a. Chama `mostrarTelaCodigoConfirmacao()`.
Â Â Â Â b. Se a validaÃ§Ã£o do PIN for `true`, chama `API.notifyDeliveryCompleted()`.
Â Â Â Â c. Se `false`, interrompe o processo.
3.2.3.2. `mostrarAvisoNovaVenda()`:
Â Â Â Â a. MÃ©todo refatorado para isolar a lÃ³gica de exibiÃ§Ã£o do diÃ¡logo de nova venda.
Â Â Â Â b. Controla o timer regressivo e os botÃµes Aceitar/Cancelar.
3.2.3.3. `mostrarTelaCodigoConfirmacao()`:
Â Â Â Â a. Apresenta a UI para inserÃ§Ã£o do PIN (TextField numÃ©rico, botÃµes).
Â Â Â Â b. Valida a entrada contra o `codigoConfirmacao` salvo em SharedPreferences.
Â Â Â Â c. Fornece feedback de erro e mantÃ©m o loop atÃ© o acerto.
Â Â Â Â d. Retorna um `bool` indicando o sucesso da validaÃ§Ã£o.
3.2.3.4. Armazenamento (Heartbeat):
Â Â Â Â a. Dentro da lÃ³gica de `API.sendHeartbeat`, ao receber `novaVenda`:
Â Â Â Â b. Verifica a existÃªncia de `codigoConfirmacao`.
Â Â Â Â c. Salva em SharedPreferences: `prefs.setInt('codigoConfirmacao', codigo);`

#### 3.2.4. **Models**

3.2.4.1.
`AuthResult`
Â Â Â Â ` dart class AuthResult { final bool success; final User? user; final bool? isNewUser; final String? error; // construtores: success, error, cancelled, timeout }  `

3.2.4.2.
`Config`
Â Â Â Â \`\`\`dart
Config.fromJson(Map\<String,dynamic\> j)
: taxa = j['taxa'].toDouble(),
distanciaMax = j['distanciaMax'],
modos = List\<String\>.from(j['modos']);

````

3.2.4.3. `User`
&nbsp;&nbsp;&nbsp;&nbsp;```dart
    User.fromJson(Map<String,dynamic> j)
        : id = j['user_id'],
          nome = j['nome'] ??
'',
          email = j['email'] ??
'',
          fotoUrl = j['fotoUrl'] ??
'',
          googleId = j['google_id'];
    ```

#### 3.2.5.
**PersistÃªncia local â€“ chaves**
3.2.5.1. **SecureStorageKeys**: `accessToken`, `refreshToken` 
3.2.5.2. **SharedPrefsKeys**: `email`, `fotoUrl`, `idUser`, `isLogado`, `nome` , `codigoConfirmacao`, `currentChamado`, `dadosNovaVenda`, `vez` (contador de heartbeat).

#### 3.2.6.
**Tratamento de erros**
3.2.6.1. `Erro de rede`: catch em `http.get`/`post` â†’ â€œVerifique sua conexÃ£oâ€ 
3.2.6.2.
`Timeout 20 s`: loop finaliza â†’ `AuthResult.timeout()` â†’ UI exibe â€œTente novamenteâ€
3.2.6.3.
`Token invÃ¡lido`: backend retorna `success=false` â†’ limpa sessÃ£o â†’ redireciona para login

---

## 4. NÃVEL DE INFRAESTRUTURA E BUILD (Opcional â€“ Profundidade Extra)

### 4.1 Scripts de Build (Windows)
4.1.1.
`compila.bat`:
&nbsp;&nbsp;&nbsp;&nbsp;a. `flutter clean`
&nbsp;&nbsp;&nbsp;&nbsp;b. `flutter pub get`
&nbsp;&nbsp;&nbsp;&nbsp;c. `gradlew clean`
&nbsp;&nbsp;&nbsp;&nbsp;d.
`flutter build apk --release --no-tree-shake-icons`
&nbsp;&nbsp;&nbsp;&nbsp;e. renomeia para `EntregaTudo.apk`
&nbsp;&nbsp;&nbsp;&nbsp;f. executa `upa.bat`

4.1.2. `upa.bat`:
&nbsp;&nbsp;&nbsp;&nbsp;a.
Copia APK para `...\public\download`
&nbsp;&nbsp;&nbsp;&nbsp;b. Executa cliente FTP (`FTPc.exe`)

### 4.2 PermissÃµes Android (`AndroidManifest.xml`)
4.2.1.
`INTERNET`
4.2.2. `ACCESS_FINE_LOCATION`
4.2.3. `ACCESS_COARSE_LOCATION`
4.2.4. `ACCESS_BACKGROUND_LOCATION`

---

## 5. ÃNDICE REMISSIVO ALFABÃ‰TICO (Termos-Chave)

- **accessToken**
- **API.fetchConfigurations**
- **API.googleLoginInit**
- **API.googleLoginStatus**
- **API.loginUser**
- **API.nextUserId**
- **API.notifyDeliveryCompleted** (Novo)
- **API.sendHeartbeat**
- **AuthResult**
- **AuthService**
- **/api/notifyDeliveryCompleted** (Novo)
- **cadboy()**
- **codigoConfirmacao** (Novo)
- **Config**
- **ConfigForm**
- **currentChamado** (Novo)
- **DeliveryCard**
- **distanciaMax**
- **FornecedorHeartbeatResponse**
- **googleLoginCallback()**
- **googleLoginStatus()**
- **handleDeliveryCompleted()** (Novo)
- **heartbeat**
- **idUser**
- **JWT**
- **lib/models**
- **LoginForm**
- **modos**
- **mostrarAvisoNovaVenda()** (Novo)
- **mostrarTelaCodigoConfirmacao()** (Novo)
- **NovaVenda**
- **obtemCfgValores()**
- **polling**
- **Provider / Bloc**
-
**refreshToken**
- **saveConfigurations()**
- **SharedPrefsKeys**
- **taxa**
- **timeout (20 s)**
- **User**
````