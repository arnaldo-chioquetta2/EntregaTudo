Perfeito, Arnaldo âœ…
A seguir estÃ¡ o **documento completo de base de conhecimento tÃ©cnica do projeto TeleTudo / Entregatudo**, organizado conforme suas instruÃ§Ãµes â€”
das camadas mais **superficiais para as mais profundas**, e **em ordem alfabÃ©tica dentro de cada seÃ§Ã£o**.

---

# ğŸ§­ Base de Conhecimento TÃ©cnica â€” Projeto **TeleTudo / Entregatudo**

## ğŸ”¹ IntroduÃ§Ã£o

O sistema **TeleTudo / Entregatudo** Ã© uma plataforma integrada de **marketplace, entregas e logÃ­stica**, com camadas BackEnd em **Laravel/PHP** e FrontEnd em **Flutter**.
Ele conecta **lojistas, motoboys e clientes**, gerenciando fluxos de pedidos, rastreamento de entregas, saldo financeiro e comunicaÃ§Ã£o em tempo real.

A arquitetura segue princÃ­pios **modulares e escalÃ¡veis**, permitindo integraÃ§Ã£o com **APIs externas** (Google, OpenPix, OpenStreetMap, etc.) e serviÃ§os internos (TeleTudo Core API, LoggerService, etc.).

---

## ğŸ—ï¸ ARQUITETURA GERAL DO SISTEMA

### ğŸ”¸ Camadas

1. **ApresentaÃ§Ã£o (FrontEnd)**
   Interface Flutter â€” apps Mobile, Web e Android TV.

2. **NegÃ³cio (LÃ³gica de AplicaÃ§Ã£o)**
   Controladores e serviÃ§os em Laravel que processam dados, aplicam validaÃ§Ãµes e coordenam chamadas externas.

3. **Dados (Modelos e RepositÃ³rios)**
   Estrutura relacional em MySQL, acessada por modelos Eloquent e consultas SQL diretas.

4. **Infraestrutura (APIs e ServiÃ§os)**
   ComunicaÃ§Ã£o entre apps, endpoints REST, autenticaÃ§Ã£o, logs, heartbeat e integraÃ§Ã£o Google.

---

## âš™ï¸ BACKEND (LARAVEL)

### ğŸ”¸ 1. Estrutura e PadrÃµes

O backend estÃ¡ organizado segundo convenÃ§Ãµes do Laravel:

```
app/
 â”œâ”€â”€ Http/
 â”‚    â”œâ”€â”€ Controllers/
 â”‚    â”‚    â”œâ”€â”€ AppController.php
 â”‚    â”‚    â”œâ”€â”€ EntregasController.php
 â”‚    â”‚    â”œâ”€â”€ GoogleLoginController.php
 â”‚    â”‚    â”œâ”€â”€ OrcamentoController.php
 â”‚    â”‚    â””â”€â”€ ...
 â”‚    â”œâ”€â”€ Middleware/
 â”‚    â”‚    â”œâ”€â”€ VerifyCsrfToken.php
 â”‚    â”‚    â”œâ”€â”€ OptionalBasicAuth.php
 â”‚    â”‚    â””â”€â”€ TrustProxies.php
 â”‚    â””â”€â”€ Kernel.php
 â”œâ”€â”€ Models/
 â”œâ”€â”€ Services/
 â”‚    â””â”€â”€ LoggerService.php
 â”œâ”€â”€ Providers/
 â””â”€â”€ ...
```

#### 1.1 ConfiguraÃ§Ãµes

* `config/cors.php` â€” libera origens cruzadas (`allowed_origins=['*']`) para apps Flutter.
* `config/app.php` â€” define timezone, locale e serviÃ§os principais.
* `app/Http/Kernel.php` â€” registra middlewares (`cors`, `csrf`, `jwt`, etc.).
* `routes/api.php` â€” expÃµe endpoints principais.

---

### ğŸ”¸ 2. Principais Endpoints e Controladores

| Endpoint                 | Controller              | DescriÃ§Ã£o                                                          |
| ------------------------ | ----------------------- | ------------------------------------------------------------------ |
| `/api/login`             | `AppController`         | AutenticaÃ§Ã£o bÃ¡sica e login de motoboys                            |
| `/api/cadboy`            | `AppController`         | Cadastro de entregador (divisÃ£o DDD/telefone, senha criptografada) |
| `/api/heartbeat`         | `AppController`         | Atualiza geolocalizaÃ§Ã£o do motoboy periodicamente                  |
| `/api/orcamento`         | `OrcamentoController`   | Calcula distÃ¢ncia e taxa de entrega com base na origem/destino     |
| `/login/google/callback` | `GoogleLoginController` | Login via OAuth2 com `accessToken` ou `idToken`                    |
| `/api/login/status`      | `AppController::status` | Retorna status da autenticaÃ§Ã£o Google (polling no app)             |

---

### ğŸ”¸ 3. MÃ©todos Internos

#### 3.1 `AppController`

* **`getNextUserId()`** â€” gera um ID sequencial para fluxo de login Google.
* **`status(Request)`** â€” retorna status atual de login baseado em `ID` (polling).
* **`heartbeat(Request)`** â€” registra posiÃ§Ã£o GPS, calcula distÃ¢ncia e responde modo de operaÃ§Ã£o.
* **`obtemCfgValores()`** â€” retorna parÃ¢metros de configuraÃ§Ã£o do sistema (taxas, distÃ¢ncias, etc.).
* **`Orcamento($qry1, $ConsF, $ConsC, $Teste, $distancia)`** â€” cÃ¡lculo de orÃ§amento e seleÃ§Ã£o automÃ¡tica de entregadora.

#### 3.2 `GoogleLoginController`

Gerencia autenticaÃ§Ã£o via **OAuth2 Google Sign-In**:

* Recebe `accessToken` ou `idToken`.
* Consulta Google API `https://www.googleapis.com/oauth2/v3/userinfo`.
* Cria ou vincula usuÃ¡rio na tabela `users`.
* Atualiza status no Redis/DB para consulta posterior pelo app.

#### 3.3 `LoggerService`

ServiÃ§o central para registrar logs uniformemente:

```php
LoggerService::loga($m, $msg, $dadosOpc = []);
```

Registra no storage (`/storage/logs/laravel.log`) e identifica rotas, parÃ¢metros e exceÃ§Ãµes.

#### 3.4 `VerifyCsrfToken`

Exclui endpoints como `/login/google/callback` da verificaÃ§Ã£o de CSRF para compatibilidade com o app Flutter.

---

### ğŸ”¸ 4. Processos EspecÃ­ficos

#### 4.1 Heartbeat

Fluxo contÃ­nuo de atualizaÃ§Ã£o de localizaÃ§Ã£o:

1. App envia `lat`, `lon`, `userid`, `vez`.
2. BackEnd grava coordenadas e responde com modo de operaÃ§Ã£o (`modo`), nova venda ou instruÃ§Ãµes.

#### 4.2 Login Google

1. App Flutter obtÃ©m `accessToken` via Google Sign-In.
2. Envia para `/login/google/callback?ID=###`.
3. Servidor consulta `/userinfo`, valida e vincula conta.
4. App realiza polling em `/api/login/status`.

#### 4.3 AutenticaÃ§Ã£o Tradicional

Valida usuÃ¡rio e senha manualmente, retornando token JWT.

---

## ğŸ“± FRONTEND (FLUTTER)

### ğŸ”¸ 1. Estrutura do Projeto

```
lib/
 â”œâ”€â”€ api.dart
 â”œâ”€â”€ auth_service.dart
 â”œâ”€â”€ models/
 â”‚    â”œâ”€â”€ nova_venda.dart
 â”‚    â””â”€â”€ fornecedor_heartbeat_response.dart
 â”œâ”€â”€ screens/
 â”‚    â”œâ”€â”€ home_page.dart
 â”‚    â”œâ”€â”€ login_page.dart
 â”‚    â”œâ”€â”€ config_page.dart
 â”‚    â””â”€â”€ ...
 â”œâ”€â”€ widgets/
 â”‚    â”œâ”€â”€ delivery_card.dart
 â”‚    â””â”€â”€ ...
 â””â”€â”€ main.dart
```

---

### ğŸ”¸ 2. Principais Classes e ServiÃ§os

#### 2.1 `API`

Classe responsÃ¡vel por requisiÃ§Ãµes HTTP.
MÃ©todos principais:

* `loginUser()`
* `nextUserId()`
* `googleLoginInit()`
* `googleLoginStatus()`
* `saldo()`
* `sendHeartbeat()`

#### 2.2 `AuthService`

Gerencia fluxo de autenticaÃ§Ã£o (login, logout, Google Sign-In, persistÃªncia).

Trecho principal:

```dart
final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
final googleAuth = await googleUser?.authentication;
final init = await API.googleLoginInit(
  idToken: googleAuth?.idToken,
  accessToken: googleAuth?.accessToken,
  userIdForQuery: queryId,
);
```

TambÃ©m salva sessÃ£o localmente com `SharedPreferences`.

#### 2.3 `HomePage` / `LoginPage`

* `HomePage` exibe dados do motoboy, saldo e pedidos.
* `LoginPage` faz autenticaÃ§Ã£o via formulÃ¡rio ou Google Sign-In.

---

### ğŸ”¸ 3. Processos Internos

#### 3.1 Polling de Login Google

ApÃ³s envio do token, o app faz polling a cada 2s no endpoint `/api/login/status`.
Assim que o backend marca `done=true`, a sessÃ£o Ã© salva e o usuÃ¡rio Ã© redirecionado para a tela principal.

#### 3.2 Heartbeat AutomÃ¡tico

Um timer (`Timer.periodic`) envia a localizaÃ§Ã£o atual via `API.sendHeartbeat()` a cada intervalo fixo, incluindo `userid`, `idLoja`, `vez`, `lat`, `lon`.

#### 3.3 Controle de SessÃ£o

* SessÃµes persistidas via `flutter_secure_storage` e `SharedPreferences`.
* Tokens e dados do usuÃ¡rio armazenados localmente:

  * `userId`
  * `accessToken`
  * `refreshToken`
  * `googleId`
  * `userEmail`

---

### ğŸ”¸ 4. Gerenciamento de Estado

Uso principal de `StatefulWidget` e `setState()` para telas simples.
Em mÃ³dulos mais avanÃ§ados (TV e painel administrativo), o padrÃ£o `Provider` ou `Bloc` Ã© usado.

---

### ğŸ”¸ 5. AutenticaÃ§Ã£o e Login Persistente

* O mÃ©todo `trySilentGoogleLogin()` tenta restaurar a sessÃ£o automaticamente com `GoogleSignIn.signInSilently()`.
* Caso falhe, exibe botÃ£o de login.

---

## ğŸ§± DETALHAMENTO PROFUNDO (por ordem alfabÃ©tica)

### A

* **API.googleLoginInit** â€” envia token Google para backend.
* **AppController** â€” controlador principal de fluxo app.
* **AuthService** â€” autenticaÃ§Ã£o Flutter (Google e manual).

### B

* **Backend** â€” Laravel 10+, PHP 8+, JWT, REST.
* **Banco de Dados** â€” MySQL com tabelas `users`, `tt_pedidos`, `et_entregador`, `tt_lojas`.

### C

* **callback()** â€” recebe tokens OAuth2 e processa login.
* **ConfiguraÃ§Ã£o Gradle** â€” `compileSdk=35`, `minSdk=23`.

### D

* **DeliveryCard** â€” exibe dados de entrega na UI Flutter.

### F

* **Firebase** â€” nÃ£o utilizado; autenticaÃ§Ã£o via Google OAuth direto.
* **Flutter** â€” versÃ£o 3.22.3; build Java 17 compatÃ­vel.

### G

* **GoogleLoginController** â€” autenticaÃ§Ã£o Google OAuth2.
* **Gradle** â€” usa `key.properties` e `.jks` para assinatura release.

### H

* **heartbeat()** â€” monitora GPS do motoboy e envia atualizaÃ§Ãµes.

### J

* **JWT** â€” usado para autenticaÃ§Ã£o tradicional.

### K

* **key.properties** â€” define senhas e alias do keystore Android.

### L

* **LoggerService** â€” loga todas as etapas crÃ­ticas.

### M

* **MainActivity** â€” activity principal Flutter Android.
* **minSdkVersion 23** â€” mÃ­nimo exigido pelo Firebase Auth plugin.

### N

* **nextUserId()** â€” gera ID para polling de login Google.

### O

* **Orcamento()** â€” calcula custo de entrega e escolhe entregadora.

### P

* **polling login/status** â€” checa status de autenticaÃ§Ã£o no app.

### R

* **Retrofit** â€” nÃ£o utilizado; app usa `http` nativo.
* **Release Build** â€” assinado via `entregatudo-release-key.jks`.

### S

* **SharedPreferences** â€” persistÃªncia de dados leves.
* **sendHeartbeat()** â€” requisiÃ§Ã£o HTTP com posiÃ§Ã£o GPS.

### V

* **VerifyCsrfToken** â€” ignora `/login/google/callback`.
* **ViewModel / Provider** â€” usado em versÃµes TV/Admin.

---

## ğŸ§© CONCLUSÃƒO

O projeto **TeleTudo / Entregatudo** Ã© um ecossistema robusto e modular,
unindo **Laravel + Flutter + Google OAuth2** com foco em entregas urbanas, controle logÃ­stico e integraÃ§Ã£o em tempo real.

Para manutenÃ§Ã£o:

* Atualize a documentaÃ§Ã£o sempre que endpoints ou modelos forem alterados.
* Use o `LoggerService` como primeira fonte de diagnÃ³stico.
* Mantenha `key.properties` e `.jks` fora do controle de versÃ£o pÃºblico.

